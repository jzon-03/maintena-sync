<div class="settings-container">
  <!-- Header Section -->
  <div class="header-section">
    <h2>System Settings</h2>
    <p class="subtitle">Configure your maintenance management system preferences</p>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons" [class.mobile]="(isHandset$ | async)">
    <button mat-raised-button color="primary" (click)="exportSettings()" [disabled]="isLoading">
      <mat-icon>download</mat-icon>
      Export Settings
    </button>
    <button mat-stroked-button color="warn" (click)="resetToDefaults()" [disabled]="isLoading">
      <mat-icon>restore</mat-icon>
      Reset to Defaults
    </button>
  </div>

  <!-- Settings Tabs -->
  <mat-card class="settings-card">
    <mat-tab-group [(selectedIndex)]="selectedTab" (selectedTabChange)="onTabChange($event.index)" 
                   [class.mobile-tabs]="(isHandset$ | async)">
      
      <!-- Profile Tab -->
      <mat-tab label="Profile">
        <ng-template matTabContent>
          <div class="tab-content">
            <div class="section-header">
              <mat-icon>person</mat-icon>
              <h3>User Profile</h3>
            </div>
            
            <form [formGroup]="profileForm" (ngSubmit)="saveProfile()">
              <div class="form-grid" [class.mobile]="(isHandset$ | async)">
                <mat-form-field appearance="outline">
                  <mat-label>First Name</mat-label>
                  <input matInput formControlName="firstName" placeholder="Enter first name">
                  <mat-error>{{ getErrorMessage(profileForm, 'firstName') }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Last Name</mat-label>
                  <input matInput formControlName="lastName" placeholder="Enter last name">
                  <mat-error>{{ getErrorMessage(profileForm, 'lastName') }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Email Address</mat-label>
                  <input matInput formControlName="email" placeholder="Enter email address">
                  <mat-icon matSuffix>email</mat-icon>
                  <mat-error>{{ getErrorMessage(profileForm, 'email') }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Role</mat-label>
                  <mat-select formControlName="role">
                    <mat-option *ngFor="let role of roles" [value]="role.value">
                      {{ role.label }}
                    </mat-option>
                  </mat-select>
                  <mat-error>{{ getErrorMessage(profileForm, 'role') }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Department</mat-label>
                  <input matInput formControlName="department" placeholder="Enter department">
                  <mat-error>{{ getErrorMessage(profileForm, 'department') }}</mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Phone Number</mat-label>
                  <input matInput formControlName="phone" placeholder="Enter phone number">
                  <mat-icon matSuffix>phone</mat-icon>
                  <mat-error>{{ getErrorMessage(profileForm, 'phone') }}</mat-error>
                </mat-form-field>
              </div>

              <div class="form-actions">
                <button mat-raised-button color="primary" type="submit" [disabled]="isLoading || profileForm.invalid">
                  <mat-icon>save</mat-icon>
                  {{ isLoading ? 'Saving...' : 'Save Profile' }}
                </button>
                <button mat-stroked-button type="button" (click)="changePassword()">
                  <mat-icon>lock</mat-icon>
                  Change Password
                </button>
              </div>
            </form>
          </div>
        </ng-template>
      </mat-tab>

      <!-- System Tab -->
      <mat-tab label="System">
        <ng-template matTabContent>
          <div class="tab-content">
            <div class="section-header">
              <mat-icon>settings</mat-icon>
              <h3>System Preferences</h3>
            </div>

            <form [formGroup]="systemForm" (ngSubmit)="saveSystemSettings()">
              <!-- Notifications Section -->
              <div class="settings-section">
                <h4>Notifications</h4>
                <div class="toggle-group">
                  <mat-slide-toggle formControlName="maintenanceReminders">
                    Maintenance Reminders
                  </mat-slide-toggle>
                  <mat-slide-toggle formControlName="emailNotifications">
                    Email Notifications
                  </mat-slide-toggle>
                  <mat-slide-toggle formControlName="smsNotifications">
                    SMS Notifications
                  </mat-slide-toggle>
                  <button mat-stroked-button type="button" (click)="testNotifications()" class="test-button">
                    <mat-icon>send</mat-icon>
                    Test Notifications
                  </button>
                </div>
              </div>

              <!-- Appearance Section -->
              <div class="settings-section">
                <h4>Appearance</h4>
                <div class="appearance-controls">
                  <mat-slide-toggle formControlName="darkMode">
                    Dark Mode
                  </mat-slide-toggle>
                </div>
              </div>

              <!-- Localization Section -->
              <div class="settings-section">
                <h4>Localization</h4>
                <div class="form-grid" [class.mobile]="(isHandset$ | async)">
                  <mat-form-field appearance="outline">
                    <mat-label>Language</mat-label>
                    <mat-select formControlName="language">
                      <mat-option *ngFor="let lang of languages" [value]="lang.value">
                        {{ lang.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Timezone</mat-label>
                    <mat-select formControlName="timezone">
                      <mat-option *ngFor="let tz of timezones" [value]="tz.value">
                        {{ tz.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Currency</mat-label>
                    <mat-select formControlName="currency">
                      <mat-option *ngFor="let curr of currencies" [value]="curr.value">
                        {{ curr.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Date Format</mat-label>
                    <mat-select formControlName="dateFormat">
                      <mat-option *ngFor="let format of dateFormats" [value]="format.value">
                        {{ format.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>

              <div class="form-actions">
                <button mat-raised-button color="primary" type="submit" [disabled]="isLoading || systemForm.invalid">
                  <mat-icon>save</mat-icon>
                  {{ isLoading ? 'Saving...' : 'Save System Settings' }}
                </button>
              </div>
            </form>
          </div>
        </ng-template>
      </mat-tab>

      <!-- Maintenance Tab -->
      <mat-tab label="Maintenance">
        <ng-template matTabContent>
          <div class="tab-content">
            <div class="section-header">
              <mat-icon>build</mat-icon>
              <h3>Maintenance Configuration</h3>
            </div>

            <form [formGroup]="maintenanceForm" (ngSubmit)="saveMaintenanceSettings()">
              <!-- Task Defaults Section -->
              <div class="settings-section">
                <h4>Task Defaults</h4>
                <div class="form-grid" [class.mobile]="(isHandset$ | async)">
                  <mat-form-field appearance="outline">
                    <mat-label>Default Task Duration (hours)</mat-label>
                    <input matInput type="number" formControlName="defaultTaskDuration" min="0.5" max="24" step="0.5">
                    <mat-error>{{ getErrorMessage(maintenanceForm, 'defaultTaskDuration') }}</mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Reminder Days Before</mat-label>
                    <input matInput type="number" formControlName="reminderDaysBefore" min="1" max="30">
                    <mat-error>{{ getErrorMessage(maintenanceForm, 'reminderDaysBefore') }}</mat-error>
                  </mat-form-field>
                </div>
              </div>

              <!-- Working Hours Section -->
              <div class="settings-section">
                <h4>Working Hours</h4>
                <div class="form-grid" [class.mobile]="(isHandset$ | async)">
                  <mat-form-field appearance="outline">
                    <mat-label>Start Time</mat-label>
                    <input matInput type="time" formControlName="workingHoursStart">
                    <mat-error>{{ getErrorMessage(maintenanceForm, 'workingHoursStart') }}</mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>End Time</mat-label>
                    <input matInput type="time" formControlName="workingHoursEnd">
                    <mat-error>{{ getErrorMessage(maintenanceForm, 'workingHoursEnd') }}</mat-error>
                  </mat-form-field>
                </div>

                <div class="toggle-group">
                  <mat-slide-toggle formControlName="weekendMaintenance">
                    Allow Weekend Maintenance
                  </mat-slide-toggle>
                  <mat-slide-toggle formControlName="autoScheduling">
                    Automatic Scheduling
                  </mat-slide-toggle>
                  <mat-slide-toggle formControlName="approvalRequired">
                    Approval Required for Tasks
                  </mat-slide-toggle>
                </div>
              </div>

              <!-- Emergency Contact Section -->
              <div class="settings-section">
                <h4>Emergency Contact</h4>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Emergency Contact Email</mat-label>
                  <input matInput formControlName="emergencyContactEmail" placeholder="emergency@company.com">
                  <mat-icon matSuffix>email</mat-icon>
                  <mat-error>{{ getErrorMessage(maintenanceForm, 'emergencyContactEmail') }}</mat-error>
                </mat-form-field>
              </div>

              <div class="form-actions">
                <button mat-raised-button color="primary" type="submit" [disabled]="isLoading || maintenanceForm.invalid">
                  <mat-icon>save</mat-icon>
                  {{ isLoading ? 'Saving...' : 'Save Maintenance Settings' }}
                </button>
              </div>
            </form>
          </div>
        </ng-template>
      </mat-tab>

      <!-- Security Tab -->
      <mat-tab label="Security">
        <ng-template matTabContent>
          <div class="tab-content">
            <div class="section-header">
              <mat-icon>security</mat-icon>
              <h3>Security & Privacy</h3>
            </div>

            <form [formGroup]="securityForm" (ngSubmit)="saveSecuritySettings()">
              <!-- Authentication Section -->
              <div class="settings-section">
                <h4>Authentication</h4>
                <div class="security-controls">
                  <div class="security-item">
                    <mat-slide-toggle formControlName="twoFactorAuth">
                      Two-Factor Authentication
                    </mat-slide-toggle>
                    <button mat-stroked-button type="button" (click)="enable2FA()" 
                            [disabled]="!securityForm.get('twoFactorAuth')?.value">
                      <mat-icon>qr_code</mat-icon>
                      Setup 2FA
                    </button>
                  </div>

                  <mat-form-field appearance="outline">
                    <mat-label>Session Timeout (minutes)</mat-label>
                    <input matInput type="number" formControlName="sessionTimeout" min="5" max="480">
                    <mat-error>{{ getErrorMessage(securityForm, 'sessionTimeout') }}</mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Password Expiry (days)</mat-label>
                    <input matInput type="number" formControlName="passwordExpiry" min="30" max="365">
                    <mat-error>{{ getErrorMessage(securityForm, 'passwordExpiry') }}</mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Max Login Attempts</mat-label>
                    <input matInput type="number" formControlName="loginAttempts" min="3" max="10">
                    <mat-error>{{ getErrorMessage(securityForm, 'loginAttempts') }}</mat-error>
                  </mat-form-field>
                </div>
              </div>

              <!-- Data & Backup Section -->
              <div class="settings-section">
                <h4>Data & Backup</h4>
                <div class="data-controls">
                  <mat-slide-toggle formControlName="auditLogging">
                    Enable Audit Logging
                  </mat-slide-toggle>

                  <mat-form-field appearance="outline">
                    <mat-label>Backup Frequency</mat-label>
                    <mat-select formControlName="dataBackupFrequency">
                      <mat-option *ngFor="let freq of backupFrequencies" [value]="freq.value">
                        {{ freq.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <button mat-stroked-button type="button" (click)="downloadAuditLog()">
                    <mat-icon>download</mat-icon>
                    Download Audit Log
                  </button>
                </div>
              </div>

              <div class="form-actions">
                <button mat-raised-button color="primary" type="submit" [disabled]="isLoading || securityForm.invalid">
                  <mat-icon>save</mat-icon>
                  {{ isLoading ? 'Saving...' : 'Save Security Settings' }}
                </button>
              </div>
            </form>
          </div>
        </ng-template>
      </mat-tab>
    </mat-tab-group>
  </mat-card>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="isLoading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Saving settings...</p>
  </div>
</div>